/*! financing_clearing_system v1.0.0
*  by [object Object]
*  (c) 2014-2016 www.frontpay.cn
* updated on 2016-11-14
*  Licensed under Apache-2.0
*/
 ~function(root,$){var profitHandler={selecteItems:[],init:function(config){config&&(this.id="addProfitDialog",this.$btn=$(config.btn),this.$container=$(config.container),this.templateId=config.templateId,this.itemSelector=config.itemSelector,this.$typer=$(config.typeElem),this.pType=0,this.onEvent())},onEvent:function(){var that=this;this.$btn.on("click",$.proxy(this.showDialog,this)),this.$container.on("click",".j-remove-item",function(){that.deleteItem(this)}),this.$container.on("click",".j-default",this.setDefault(this)),this.$typer.on("change",this.changeType(this)),this.checkTyper(),this.$container.on("blur",".form-control",$.proxy(this.autoTotal,this))},showDialog:function(){var t=+new Date,url=this.$btn.attr("data-url");url=url.indexOf("?")>-1?url+"&_cache="+t:url+"?_cache="+t,$("#"+this.id).iframeModal({title:"添加分润对象",url:url})},addList:function(list){for(var $item,res=[],i=0;i<list.length;i++)$item=$(this.itemSelector+list[i].id),$item.length||res.push(list[i]);if(res.length){var listHtml=template(this.templateId,{list:res});this.$container.append(listHtml),this.totalHandler(),this.checkTyper()}},addItem:function(item){var $item,items=this.selecteItems,isExists=!1;if(item&&item.id)for(var i=0,len=items.length;i<len;i++)$item=$(this.itemSelector+item.id),(items[i].id===item.id||$item.length>0)&&(isExists=!0);isExists||this.selecteItems.push(item)},removeItem:function(id){var that=this,items=this.selecteItems;if(id)for(var i=0,len=items.length;i<len;i++)items[i]&&items[i].id==id&&items.splice(i,1);$(that.itemSelector+id).remove(),this.selecteItems=items,this.totalHandler()},emptyItem:function(){},setDefault:function(that){return function(){var $parents=$(this).parents(".form-group"),$input=$parents.find(".form-control"),readOnly=$input.prop("readonly"),txt=readOnly?"设为默认":"取消默认";readOnly?$input.removeProp("readonly"):$input.prop("readonly","readonly"),$(this).html(txt),that.totalHandler()}},deleteItem:function(obj){var that=this,mid=$(obj).attr("data-mid");that.confirm(function(){that.removeItem(mid)})},confirm:function(callback){confirmModalLayer({id:"#j-deleteItem-modal",title:"是否删除此分润对象？",callback:function(){return closeModalLayer("#j-deleteItem-modal",callback),!1}})},changeType:function(that){return function(e){var $this=$(this);that.$typer.not($this).prop("checked",!0),$this.prop("checked",!1);var callback=function(){$this.prop("checked",!0),that.pType=parseInt($this.attr("data-type")),that.showDefaultBtn(that.pType),0==that.pType&&that.$container.find(".form-control").removeProp("readonly").end().find(".j-default").html("设为默认"),that.clearProfitText()};confirmModalLayer({title:"确定要切换分润模式？",content:"将清空已设置的分润对象数据",callback:callback}),e.preventDefault()}},checkTyper:function(){var $curObj=this.$typer.filter(":checked"),pType=parseInt($curObj.attr("data-type"));this.pType=pType,1===pType&&this.showDefaultBtn(1)},showDefaultBtn:function(toggle){this.$container.find(".j-def-btn")[toggle?"show":"hide"]()},clearProfitText:function(){this.$container.find(".form-control").val("")},autoTotal:function(){this.checkTyper(),1==this.pType&&this.totalHandler()},totalHandler:function(curObj){var $inputs=this.$container.find(".form-control"),baseVal=0,MAX=100,count=0,autoLen=0,num=0,autoElems=[];$inputs.length>1&&($inputs.map(function(){$(this).prop("readonly")?(autoLen++,autoElems.push($(this))):(baseVal=parseFloat($(this).val()),baseVal=isNaN(baseVal)?0:Number(baseVal),$(this).val(baseVal),count+=baseVal)}),autoLen>0&&(num=(MAX-count)/autoLen,$.map(autoElems,function(item){$(item).val(num)})))}},pageInit=function(){profitHandler.init({btn:"#j-add-profit",container:"#j-profit-container",templateId:"j-items-tmpl",itemSelector:"#j-item-",typeElem:".j-profit-type"});var quickDraw=function(obj){var isChecked=$(obj)[0].checked;$(".j-quickDrwa-group").find("input").prop("readonly",!isChecked)};$("#j-quickDraw").on("click",function(){quickDraw(this)}),quickDraw($("#j-quickDraw"));var $inputPlatform=$("#j-input-paltform");$("#j-input-user").on("keyup",function(){var thisVal=Number($(this).val())||0;$inputPlatform.val(100-thisVal)})};$(pageInit),root.profitHandler=profitHandler}(window,jQuery);