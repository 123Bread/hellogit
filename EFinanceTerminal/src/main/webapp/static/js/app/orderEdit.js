/*! financing_clearing_system v1.0.0
*  by [object Object]
*  (c) 2014-2016 www.frontpay.cn
* updated on 2016-11-14
*  Licensed under Apache-2.0
*/
 !function(){template.helper("toFixed",function(num,unit){return(parseFloat(num)||0).toFixed(unit)});var PickUser=function(){var handler={init:function(obj,idObj,btn){this.obj=$(obj),this.idObj=$(idObj),this.btn=$(btn),this.btn.on("click",function(){var target=$(this).data("target");target&&handler.show(target)})},show:function(url){$("#modal-pick-user").iframeModal({title:"选择出货人",url:url})},pick:function(data){data&&(this.obj.val(data.title),this.idObj.val(data.mid)),$("#modal-pick-user").modal("hide")}};return handler}(),GoodList=function(config){return config&&"object"==typeof config?(this.uuid=Math.random().toString(36).slice(2,7),this.config=config,this.container=$(config.container),this.addBtn=$(config.addBtn),this.objTotal=$(config.total),this.postContainer=$(config.postContainer),void this.init()):this};GoodList.prototype={init:function(){var that=this;this.collection=[],$(document).on("click",this.config.addBtn,$.proxy(this.add,this)),$(document).on("click",this.config.editBtn,function(e){e.preventDefault(),that.edit(this)}),$(document).on("click",this.config.removeBtn,function(e){e.preventDefault(),that.remove(this)})},add:function(){this.editPopup()},addItem:function(){var oForm=$("#goods-addform-"+this.uuid);if(oForm.length){var data=oForm.serializeArray();data&&(data=formatJSON(data)),parseInt(data.mid)>=0?this.collection.splice(data.mid,1,data):this.collection.push(data),this.render(),$("#pop-"+this.uuid).modal("hide")}},edit:function(obj){if(obj){var mid=$(obj).data("mid");null!=mid&&void 0!=mid&&this.editPopup(mid,this.collection[mid])}},remove:function(obj){if(obj){var that=this,mid=$(obj).data("mid");null!=mid&&void 0!=mid&&confirmModalLayer({title:"确定删除已录入信息？",callback:function(){that.removeItem(mid)}})}},removeItem:function(id){this.collection.splice(id,1),this.render()},render:function(){$.map(this.collection,function(item){return item.total=(item.price*item.currency).toFixed(2),item});var items=template(this.config.itemTmpl,{list:this.collection}),postDatas=template(this.config.dataTmpl,{list:this.collection});this.container.html(items),this.postContainer.html(postDatas),this.updateTotal()},updateTotal:function(){this.config.fnTotal&&"function"==typeof this.config.fnTotal&&this.config.fnTotal(this.objTotal,this.collection)},editPopup:function(mid,data){var that=this,title=data?"修改":"添加";mid="number"==typeof parseInt(mid)?mid:"",data&&""===data.mid&&(data.mid=mid),data=$.extend({uuid:this.uuid,mid:mid},data);var content=template(this.config.popTmpl,data);$("#pop-"+this.uuid).modal({title:title+"货物信息",content:content}),$("#goods-addform-"+this.uuid).validate({submitHandler:function(){that.addItem()}})}};var appInit=function(){PickUser.init("#form-control-3","#userId","#j-pick-btn");var oDrop=(new GoodList({container:"#j-goods",addBtn:"#j-goods-add",total:"#j-goods-total",removeBtn:".j-remove-item",editBtn:".j-edit-item",itemTmpl:"j-tmpl-goods-item",dataTmpl:"j-tmpl-goods-data",postContainer:"#j-goods-post",popTmpl:"j-tmpl-goods-addform",fnTotal:function(obj,data){var i=0,len=0,total=0;for(len=data.length;i<len;i++)total+=data[i].price*data[i].currency;total=isNaN(total)?0:total,obj.html(total.toFixed(2))}}),$("#form-control-24")),oContent=$("#j-drop-div");oDrop.on("change",function(){oContent[1==$(this).val()?"show":"hide"]()}),$('[data-toggle="upload"]').each(function(){var fileId=$(this).attr("data-target");if(fileId){var option={auto:!1,swf:"",server:"",inputText:fileId,uploadBeforeSend:function(block,data){},beforeUpload:function(){return!0}};$(this).fileUpload(option)}})};$(appInit),window.PickUser=PickUser}();